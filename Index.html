<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JAN&ME</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; min-height: 100vh; }
    
    .header { background: linear-gradient(135deg, #FF6B6B, #FF8E53); color: white; padding: 20px; text-align: center; }
    .header h1 { font-size: 24px; margin-bottom: 5px; }
    
    .tabs { display: flex; background: white; border-bottom: 1px solid #eee; }
    .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; border-bottom: 3px solid transparent; }
    .tab.active { color: #FF6B6B; border-bottom-color: #FF6B6B; font-weight: bold; }
    
    .content { padding: 15px; max-width: 500px; margin: 0 auto; }
    .section { display: none; }
    .section.active { display: block; }
    
    .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .card-title { font-size: 16px; font-weight: bold; margin-bottom: 15px; color: #333; }
    
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; font-size: 14px; color: #666; margin-bottom: 5px; }
    .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
    
    .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
    .btn-primary { background: #FF6B6B; color: white; }
    
    .order-item { background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .order-id { font-weight: bold; color: #FF6B6B; }
    .order-status { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 12px; background: #FFF3CD; color: #856404; }
    
    .empty { text-align: center; padding: 40px; color: #999; }
    
    .loading { text-align: center; padding: 40px; }
    .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #FF6B6B; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 8px; display: none; }
    .toast.show { display: block; }
    
    .profile-pic { width: 60px; height: 60px; border-radius: 50%; }
    .profile-name { font-size: 18px; font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>

<div class="header">
  <h1>üè™ JAN&ME</h1>
  <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Order</p>
</div>

<div class="tabs">
  <div class="tab active" onclick="switchTab('info')">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
  <div class="tab" onclick="switchTab('orders')">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
</div>

<div class="content">
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
  </div>
  
  <div id="info-section" class="section">
    <div class="card" style="text-align: center;">
      <img id="profile-pic" class="profile-pic" src="" alt="">
      <div id="profile-name" class="profile-name">-</div>
    </div>
    
    <div class="card">
      <div class="card-title">üõí Shopee ID</div>
      <div class="form-group">
        <label>‡πÑ‡∏≠‡∏î‡∏µ Shopee (‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏≠‡∏î‡∏µ‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ,)</label>
        <input type="text" id="shopee-ids" placeholder="‡πÄ‡∏ä‡πà‡∏ô shopee_user1, shopee_user2">
      </div>
    </div>
    
    <div class="card">
      <div class="card-title">üè¶ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</div>
      <div class="form-group">
        <label>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</label>
        <select id="bank-name">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ --</option>
          <option value="‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢">‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢</option>
          <option value="‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û">‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û</option>
          <option value="‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢">‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢</option>
          <option value="‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå">‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå</option>
          <option value="‡∏ó‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏ò‡∏ô‡∏ä‡∏≤‡∏ï">‡∏ó‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏ò‡∏ô‡∏ä‡∏≤‡∏ï</option>
          <option value="‡∏Å‡∏£‡∏∏‡∏á‡∏®‡∏£‡∏µ">‡∏Å‡∏£‡∏∏‡∏á‡∏®‡∏£‡∏µ</option>
          <option value="‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô">‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô</option>
          <option value="PromptPay">PromptPay</option>
        </select>
      </div>
      <div class="form-group">
        <label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
        <input type="text" id="bank-account" placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏ö‡∏≠‡∏£‡πå PromptPay">
      </div>
      <div class="form-group">
        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
        <input type="text" id="account-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
      </div>
      <button class="btn btn-primary" onclick="saveData()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>
  </div>
  
  <div id="orders-section" class="section">
    <div id="orders-list"></div>
  </div>
</div>

<div class="toast" id="toast"></div>
<div id="debug" style="background:#333;color:#0f0;padding:10px;font-size:12px;font-family:monospace;margin:10px;border-radius:8px;"></div>

<script>
var userId = null;

function log(msg) {
  console.log(msg);
  var d = document.getElementById('debug');
  d.innerHTML += msg + '<br>';
}

async function init() {
  try {
    log('1. Starting LIFF...');
    log('LIFF ID: 2009026931-IQy8q5QZ');
    
    // Check if LIFF SDK loaded
    if (typeof liff === 'undefined') {
      log('ERROR: LIFF SDK not loaded!');
      return;
    }
    log('1.1 LIFF SDK loaded OK');
    
    // Init with timeout
    log('1.2 Calling liff.init()...');
    var initPromise = liff.init({ liffId: '2009026931-IQy8q5QZ' });
    var timeoutPromise = new Promise(function(resolve, reject) {
      setTimeout(function() { reject(new Error('LIFF init timeout (10s)')); }, 10000);
    });
    
    await Promise.race([initPromise, timeoutPromise]);
    log('2. LIFF init OK');
    
    log('3. isLoggedIn: ' + liff.isLoggedIn());
    log('4. isInClient: ' + liff.isInClient());
    log('4.1 OS: ' + liff.getOS());
    
    if (!liff.isLoggedIn()) {
      log('5. Not logged in - calling liff.login()...');
      liff.login();
      return;
    }
    
    log('6. Getting profile...');
    var profile = await liff.getProfile();
    userId = profile.userId;
    
    log('7. UserId: ' + userId);
    log('8. Name: ' + profile.displayName);
    
    document.getElementById('profile-pic').src = profile.pictureUrl || '';
    document.getElementById('profile-name').textContent = profile.displayName;
    
    log('9. Loading data from server...');
    loadData();
  } catch (err) {
    log('ERROR: ' + (err.code || '') + ' - ' + (err.message || err));
    console.error(err);
    document.getElementById('loading').innerHTML = '<p style="color:red;">Error: ' + (err.message || err) + '</p>';
  }
}

function loadData() {
  log('10. Calling API via fetch...');
  
  var apiUrl = 'https://script.google.com/macros/s/AKfycbxc1W4MgiGHFnLh8SrfHeqCbKPU033zbfSoTr-TUeGHuTy4qKcPjeZEvgqXC1PyAYiM/exec';
  
  fetch(apiUrl + '?action=getUserData&userId=' + encodeURIComponent(userId))
    .then(function(response) { 
      log('11. Response status: ' + response.status);
      return response.json(); 
    })
    .then(function(data) {
      log('12. Data received');
      
      if (data.user) {
        log('13. User: ' + data.user.displayName);
        document.getElementById('shopee-ids').value = data.user.shopeeIds || '';
        document.getElementById('bank-name').value = data.user.bankName || '';
        document.getElementById('bank-account').value = data.user.bankAccount || '';
        document.getElementById('account-name').value = data.user.accountName || '';
      } else {
        log('13. No user');
      }
      
      log('14. Orders: ' + (data.orders ? data.orders.length : 0));
      renderOrders(data.orders || []);
      
      document.getElementById('loading').style.display = 'none';
      document.getElementById('info-section').classList.add('active');
      log('15. DONE!');
    })
    .catch(function(err) {
      log('ERROR fetch: ' + err.message);
      document.getElementById('loading').style.display = 'none';
      document.getElementById('info-section').classList.add('active');
    });
}

function saveData() {
  var shopeeIds = document.getElementById('shopee-ids').value.trim();
  var bankName = document.getElementById('bank-name').value;
  var bankAccount = document.getElementById('bank-account').value.trim();
  var accountName = document.getElementById('account-name').value.trim();
  
  google.script.run
    .withSuccessHandler(function(result) {
      var data = JSON.parse(result);
      if (data.success) {
        showToast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
      } else {
        showToast('‚ùå ' + (data.error || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'));
      }
    })
    .withFailureHandler(function(err) {
      showToast('‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    })
    .updateUserDataApi(userId, shopeeIds, bankName, bankAccount, accountName);
}

function renderOrders(orders) {
  var container = document.getElementById('orders-list');
  
  if (orders.length === 0) {
    container.innerHTML = '<div class="empty">üì≠ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Order</div>';
    return;
  }
  
  var html = '';
  for (var i = 0; i < orders.length; i++) {
    var order = orders[i];
    html += '<div class="order-item">' +
      '<div style="display:flex;justify-content:space-between;align-items:center;">' +
        '<span class="order-id">üÜî ' + order.orderId + '</span>' +
        '<span class="order-status">' + order.status + '</span>' +
      '</div>' +
      '<div style="font-size:18px;font-weight:bold;margin:8px 0;">‡∏ø' + (order.orderTotal || '-') + '</div>' +
      '<div style="font-size:13px;color:#888;">üïê ' + (order.orderTime || '-') + '</div>' +
    '</div>';
  }
  
  container.innerHTML = html;
}

function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
  document.querySelectorAll('.section').forEach(function(s) { s.classList.remove('active'); });
  
  event.target.classList.add('active');
  document.getElementById(tab + '-section').classList.add('active');
}

function showToast(msg) {
  var toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(function() { toast.classList.remove('show'); }, 2500);
}

init();
</script>

</body>
</html>
