<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JAN&ME</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; min-height: 100vh; }
    
    .header { background: linear-gradient(135deg, #FF6B6B, #FF8E53); color: white; padding: 20px; text-align: center; }
    .header h1 { font-size: 22px; margin-bottom: 4px; }
    .header p { font-size: 13px; opacity: 0.9; }
    
    .tabs { display: flex; background: white; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 100; }
    .tab { flex: 1; padding: 14px; text-align: center; cursor: pointer; border-bottom: 3px solid transparent; font-size: 14px; transition: all 0.2s; }
    .tab.active { color: #FF6B6B; border-bottom-color: #FF6B6B; font-weight: 600; }
    
    .content { padding: 15px; max-width: 500px; margin: 0 auto; padding-bottom: 30px; }
    .section { display: none; }
    .section.active { display: block; }
    
    /* Profile */
    .profile-section { display: flex; align-items: center; gap: 15px; padding: 16px; background: white; border-radius: 16px; margin-bottom: 15px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); }
    .profile-pic { width: 56px; height: 56px; border-radius: 50%; border: 3px solid #FF6B6B; }
    .profile-info { flex: 1; }
    .profile-name { font-size: 18px; font-weight: 600; color: #333; }
    .profile-id { font-size: 12px; color: #999; margin-top: 2px; }
    
    /* Summary Cards */
    .summary-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
    .summary-card { background: white; border-radius: 16px; padding: 16px; text-align: center; box-shadow: 0 2px 12px rgba(0,0,0,0.06); position: relative; overflow: hidden; }
    .summary-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; }
    .summary-card.pending::before { background: linear-gradient(90deg, #ffc107, #ffdb4d); }
    .summary-card.deposit::before { background: linear-gradient(90deg, #17a2b8, #4dd0e1); }
    .summary-icon { font-size: 28px; margin-bottom: 8px; }
    .summary-label { font-size: 12px; color: #888; margin-bottom: 4px; }
    .summary-value { font-size: 22px; font-weight: 700; }
    .summary-card.pending .summary-value { color: #e6a700; }
    .summary-card.deposit .summary-value { color: #17a2b8; }
    
    /* Section Title */
    .section-title { display: flex; justify-content: space-between; align-items: center; margin: 20px 0 12px; padding: 0 4px; }
    .section-title h2 { font-size: 15px; color: #333; font-weight: 600; }
    .btn-add { background: linear-gradient(135deg, #FF6B6B, #FF8E53); color: white; border: none; width: 32px; height: 32px; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(255,107,107,0.4); }
    
    /* Shopee Grid */
    .shopee-grid { display: grid; gap: 12px; }
    .shopee-grid.single { grid-template-columns: 1fr; }
    .shopee-grid.multi { grid-template-columns: 1fr 1fr; }
    
    /* Shopee Card */
    .shopee-card { background: white; border-radius: 16px; padding: 14px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
    .shopee-card:active { transform: scale(0.98); }
    .shopee-card.full { display: flex; align-items: center; gap: 12px; }
    .shopee-card.compact { text-align: center; padding: 16px 12px; }
    
    .shopee-icon { width: 44px; height: 44px; background: linear-gradient(135deg, #EE4D2D, #FF6633); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; flex-shrink: 0; }
    .shopee-card.compact .shopee-icon { width: 40px; height: 40px; margin: 0 auto 10px; font-size: 18px; }
    
    .shopee-info { flex: 1; min-width: 0; }
    .shopee-name { font-weight: 600; font-size: 14px; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .shopee-card.compact .shopee-name { font-size: 13px; margin-bottom: 8px; }
    
    .shopee-stats { display: flex; align-items: center; gap: 6px; margin-top: 4px; font-size: 12px; }
    .shopee-card.compact .shopee-stats { justify-content: center; }
    .stat-paid { color: #28a745; font-weight: 600; }
    .stat-total { color: #666; }
    
    /* Progress Ring */
    .progress-ring { width: 44px; height: 44px; position: relative; flex-shrink: 0; }
    .shopee-card.compact .progress-ring { width: 46px; height: 46px; margin: 0 auto 6px; }
    .progress-ring svg { transform: rotate(-90deg); }
    .progress-ring circle { fill: none; stroke-width: 4; }
    .progress-ring .bg { stroke: #eee; }
    .progress-ring .progress { stroke: #28a745; stroke-linecap: round; }
    .progress-ring .progress.warning { stroke: #ffc107; }
    .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 10px; font-weight: 700; color: #333; }
    
    /* Bank Card */
    .bank-card { background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 16px; padding: 20px; color: white; box-shadow: 0 4px 15px rgba(102,126,234,0.4); cursor: pointer; transition: transform 0.2s; }
    .bank-card:active { transform: scale(0.98); }
    .bank-label { font-size: 10px; opacity: 0.8; text-transform: uppercase; letter-spacing: 1px; }
    .bank-name { font-size: 18px; font-weight: 700; margin: 2px 0 12px; }
    .bank-account { font-size: 16px; letter-spacing: 2px; font-family: monospace; }
    .bank-holder { margin-top: 12px; font-size: 13px; opacity: 0.9; }
    .bank-phone { margin-top: 6px; font-size: 12px; opacity: 0.8; }
    
    /* Empty State */
    .empty-state { background: white; border-radius: 16px; text-align: center; padding: 30px 20px; color: #999; box-shadow: 0 2px 12px rgba(0,0,0,0.06); }
    .empty-state .icon { font-size: 40px; margin-bottom: 10px; }
    .empty-state p { font-size: 13px; margin-bottom: 15px; }
    .empty-state .btn { padding: 12px 24px; }
    
    /* Order Card */
    .order-card { background: white; border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); cursor: pointer; transition: transform 0.2s; }
    .order-card:active { transform: scale(0.98); }
    .order-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
    .order-id { font-weight: 600; color: #FF6B6B; font-size: 14px; }
    .order-status { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 500; }
    .order-status.pending { background: #FFF3CD; color: #856404; }
    .order-status.completed { background: #D4EDDA; color: #155724; }
    .order-body { display: flex; justify-content: space-between; align-items: center; }
    .order-amount { font-size: 20px; font-weight: 700; color: #333; }
    .order-meta { text-align: right; }
    .order-time { font-size: 12px; color: #888; }
    .order-by { font-size: 11px; margin-top: 4px; }
    .order-by.user { color: #FF6B6B; }
    .order-by.admin { color: #28a745; }
    .order-refund { font-size: 12px; color: #17a2b8; margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee; }
    
    /* Filter */
    .filter-row { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
    .filter-btn { padding: 8px 16px; border: 1px solid #ddd; border-radius: 20px; font-size: 12px; white-space: nowrap; cursor: pointer; background: white; transition: all 0.2s; }
    .filter-btn.active { background: #FF6B6B; color: white; border-color: #FF6B6B; }
    
    /* Modal */
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
    .modal-overlay.show { display: flex; }
    .modal { background: white; border-radius: 20px; width: 100%; max-width: 360px; max-height: 90vh; overflow: hidden; animation: modalIn 0.3s ease; }
    @keyframes modalIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .modal-header { background: linear-gradient(135deg, #FF6B6B, #FF8E53); color: white; padding: 18px; text-align: center; }
    .modal-header h3 { font-size: 17px; }
    .modal-body { padding: 20px; max-height: 60vh; overflow-y: auto; }
    .modal-body .form-group { margin-bottom: 15px; }
    .modal-body label { display: block; font-size: 13px; color: #666; margin-bottom: 6px; font-weight: 500; }
    .modal-body input, .modal-body select { width: 100%; padding: 14px; border: 2px solid #eee; border-radius: 12px; font-size: 16px; transition: border-color 0.2s; }
    .modal-body input:focus, .modal-body select:focus { outline: none; border-color: #FF6B6B; }
    .modal-body input:disabled { background: #f5f5f5; color: #999; }
    .modal-actions { display: flex; gap: 10px; padding: 0 20px 20px; }
    .modal-actions button { flex: 1; padding: 14px; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; }
    .btn-cancel { background: #f5f5f5; color: #666; }
    .btn-save { background: linear-gradient(135deg, #FF6B6B, #FF8E53); color: white; }
    .btn-delete { background: #dc3545; color: white; }
    .btn-secondary { background: #6c757d; color: white; }
    
    /* History */
    .history-item { padding: 10px; border-bottom: 1px solid #eee; font-size: 12px; }
    .history-item:last-child { border-bottom: none; }
    .history-time { color: #999; margin-bottom: 4px; }
    .history-change { color: #333; }
    .history-change .old { color: #dc3545; text-decoration: line-through; }
    .history-change .new { color: #28a745; }
    
    /* Order Image */
    .order-image { width: 100%; border-radius: 12px; margin-bottom: 15px; }
    
    /* Toast */
    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 8px; display: none; z-index: 2000; font-size: 14px; }
    .toast.show { display: block; }
    
    /* Loading */
    .loading { text-align: center; padding: 40px; }
    .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #FF6B6B; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

<div class="header">
  <h1>üè™ JAN&ME</h1>
  <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Order</p>
</div>

<div class="tabs">
  <div class="tab active" onclick="switchTab('info')">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
  <div class="tab" onclick="switchTab('orders')">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
</div>

<div class="content">
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
  </div>
  
  <!-- INFO SECTION -->
  <div id="info-section" class="section">
    <!-- Profile -->
    <div class="profile-section">
      <img id="profile-pic" class="profile-pic" src="" alt="">
      <div class="profile-info">
        <div id="profile-name" class="profile-name">-</div>
        <div class="profile-id">LINE Member ‚Ä¢ <span id="total-orders">0</span> orders</div>
      </div>
    </div>
    
    <!-- Summary -->
    <div class="summary-row">
      <div class="summary-card pending">
        <div class="summary-icon">üí∞</div>
        <div class="summary-label">‡∏¢‡∏≠‡∏î‡∏£‡∏≠‡∏Ñ‡∏∑‡∏ô</div>
        <div id="total-refund" class="summary-value">‡∏ø0</div>
      </div>
      <div class="summary-card deposit">
        <div class="summary-icon">üè¶</div>
        <div class="summary-label">‡∏¢‡∏≠‡∏î‡∏°‡∏±‡∏î‡∏à‡∏≥</div>
        <div id="total-deposit" class="summary-value">‡∏ø0</div>
      </div>
    </div>
    
    <!-- Shopee IDs -->
    <div class="section-title">
      <h2>üõí Shopee ID</h2>
      <button class="btn-add" onclick="showAddShopeeModal()">+</button>
    </div>
    <div id="shopee-list"></div>
    
    <!-- Bank -->
    <div class="section-title">
      <h2>üè¶ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h2>
    </div>
    <div id="bank-display"></div>
  </div>
  
  <!-- ORDERS SECTION -->
  <div id="orders-section" class="section">
    <div class="filter-row">
      <button class="filter-btn active" onclick="filterOrders('all', this)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      <button class="filter-btn" onclick="filterOrders('user', this)">üë§ ‡∏â‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
      <button class="filter-btn" onclick="filterOrders('admin', this)">üõí Admin</button>
      <button class="filter-btn" onclick="filterOrders('pending', this)">‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à</button>
      <button class="filter-btn" onclick="filterOrders('completed', this)">‡πÇ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß</button>
    </div>
    <div id="orders-list"></div>
  </div>
</div>

<!-- MODALS -->

<!-- Add Shopee ID -->
<div class="modal-overlay" id="addShopeeModal">
  <div class="modal">
    <div class="modal-header"><h3>üõí ‡πÄ‡∏û‡∏¥‡πà‡∏° Shopee ID</h3></div>
    <div class="modal-body">
      <div class="form-group">
        <label>Shopee ID / ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô</label>
        <input type="text" id="new-shopee-id" placeholder="‡πÄ‡∏ä‡πà‡∏ô momojun36">
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="hideModal('addShopeeModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn-save" onclick="addShopeeId()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
  </div>
</div>

<!-- View/Delete Shopee ID -->
<div class="modal-overlay" id="viewShopeeModal">
  <div class="modal">
    <div class="modal-header"><h3>üõí Shopee ID</h3></div>
    <div class="modal-body">
      <div style="text-align:center; padding: 20px 0;">
        <div class="shopee-icon" style="width:60px;height:60px;font-size:28px;margin:0 auto 15px;">üõí</div>
        <div id="view-shopee-name" style="font-size:20px;font-weight:600;margin-bottom:10px;"></div>
        <div id="view-shopee-stats" style="font-size:14px;color:#666;"></div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="hideModal('viewShopeeModal')">‡∏õ‡∏¥‡∏î</button>
      <button class="btn-delete" onclick="confirmDeleteShopee()">üóëÔ∏è ‡∏•‡∏ö</button>
    </div>
  </div>
</div>

<!-- Add/Edit Bank -->
<div class="modal-overlay" id="bankModal">
  <div class="modal">
    <div class="modal-header"><h3>üè¶ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h3></div>
    <div class="modal-body">
      <div class="form-group">
        <label>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</label>
        <select id="input-bank-name">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ --</option>
          <option value="‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢">‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢</option>
          <option value="‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û">‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û</option>
          <option value="‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢">‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢</option>
          <option value="‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå">‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå</option>
          <option value="‡∏ó‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏ò‡∏ô‡∏ä‡∏≤‡∏ï">‡∏ó‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏ò‡∏ô‡∏ä‡∏≤‡∏ï</option>
          <option value="‡∏Å‡∏£‡∏∏‡∏á‡∏®‡∏£‡∏µ">‡∏Å‡∏£‡∏∏‡∏á‡∏®‡∏£‡∏µ</option>
          <option value="‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô">‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô</option>
          <option value="PromptPay">PromptPay</option>
        </select>
      </div>
      <div class="form-group">
        <label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
        <input type="text" id="input-bank-account" placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏ö‡∏≠‡∏£‡πå PromptPay">
      </div>
      <div class="form-group">
        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
        <input type="text" id="input-account-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
      </div>
      <div class="form-group">
        <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
        <input type="tel" id="input-phone" placeholder="08X-XXX-XXXX">
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="hideModal('bankModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn-save" onclick="saveBank()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
  </div>
</div>

<!-- Order Detail -->
<div class="modal-overlay" id="orderModal">
  <div class="modal" style="max-width:400px;">
    <div class="modal-header"><h3>üì¶ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î Order</h3></div>
    <div class="modal-body" id="order-modal-body">
      <!-- Dynamic content -->
    </div>
    <div class="modal-actions" id="order-modal-actions">
      <button class="btn-cancel" onclick="hideModal('orderModal')">‡∏õ‡∏¥‡∏î</button>
      <button class="btn-save" onclick="saveOrder()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
  </div>
</div>

<!-- Confirm Delete -->
<div class="modal-overlay" id="confirmModal">
  <div class="modal" style="max-width:300px;">
    <div class="modal-body" style="text-align:center; padding:30px;">
      <div style="font-size:40px;margin-bottom:15px;">‚ö†Ô∏è</div>
      <p style="font-size:15px;color:#333;margin-bottom:10px;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?</p>
      <p style="font-size:13px;color:#888;">‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ</p>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="hideModal('confirmModal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn-delete" id="confirm-delete-btn">‡∏•‡∏ö</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
var CONFIG = {
  LIFF_ID: '2009026931-IQy8q5QZ',
  API_URL: 'https://script.google.com/macros/s/AKfycbxc1W4MgiGHFnLh8SrfHeqCbKPU033zbfSoTr-TUeGHuTy4qKcPjeZEvgqXC1PyAYiM/exec'
};

var userId = null;
var userData = null;
var currentShopeeId = null;
var currentOrderId = null;
var currentFilter = 'all';

// ===== INIT =====
async function init() {
  try {
    await liff.init({ liffId: CONFIG.LIFF_ID });
    
    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }
    
    var profile = await liff.getProfile();
    userId = profile.userId;
    
    document.getElementById('profile-pic').src = profile.pictureUrl || '';
    document.getElementById('profile-name').textContent = profile.displayName;
    
    // Check URL params
    var params = new URLSearchParams(window.location.search);
    if (params.get('tab') === 'orders') {
      switchTab('orders');
    }
    
    loadUserData();
    
  } catch (err) {
    document.getElementById('loading').innerHTML = '<p style="color:red;">Error: ' + err.message + '</p>';
  }
}

// ===== API =====
function apiCall(action, params) {
  params = params || {};
  params.action = action;
  params.userId = userId;
  
  var url = CONFIG.API_URL + '?' + new URLSearchParams(params).toString();
  return fetch(url).then(r => r.json());
}

// ===== LOAD DATA =====
function loadUserData() {
  apiCall('getUserData').then(function(data) {
    if (data.success) {
      userData = data;
      renderAll();
    }
    document.getElementById('loading').style.display = 'none';
    document.getElementById('info-section').classList.add('active');
  }).catch(function(err) {
    showToast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    document.getElementById('loading').style.display = 'none';
    document.getElementById('info-section').classList.add('active');
  });
}

function renderAll() {
  // Summary
  document.getElementById('total-orders').textContent = userData.totalOrders || 0;
  document.getElementById('total-refund').textContent = '‡∏ø' + numberFormat(userData.totalRefund || 0);
  document.getElementById('total-deposit').textContent = '‡∏ø' + numberFormat(userData.totalDeposit || 0);
  
  renderShopeeIds();
  renderBank();
}

// ===== SHOPEE IDs =====
function renderShopeeIds() {
  var container = document.getElementById('shopee-list');
  var ids = userData.shopeeIds || [];
  
  if (ids.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="icon">üõí</div><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Shopee ID</p><button class="btn-save btn" onclick="showAddShopeeModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏° Shopee ID</button></div>';
    return;
  }
  
  var gridClass = ids.length === 1 ? 'single' : 'multi';
  var cardClass = ids.length === 1 ? 'full' : 'compact';
  
  var html = '<div class="shopee-grid ' + gridClass + '">';
  ids.forEach(function(item) {
    var pct = item.totalOrders > 0 ? Math.round((item.paidOrders / item.totalOrders) * 100) : 0;
    var circumference = 2 * Math.PI * 18;
    var offset = circumference - (pct / 100) * circumference;
    var progressClass = pct === 0 ? 'warning' : '';
    var pctColor = pct === 0 ? '#ffc107' : '#333';
    
    if (cardClass === 'full') {
      html += '<div class="shopee-card full" onclick="viewShopeeId(\'' + item.shopeeId + '\')">' +
        '<div class="shopee-icon">üõí</div>' +
        '<div class="shopee-info">' +
          '<div class="shopee-name">' + item.shopeeId + '</div>' +
          '<div class="shopee-stats"><span class="stat-paid">‚úì ' + item.paidOrders + '</span><span class="stat-total">/ ' + item.totalOrders + ' orders</span></div>' +
        '</div>' +
        '<div class="progress-ring">' +
          '<svg width="44" height="44"><circle class="bg" cx="22" cy="22" r="18"/><circle class="progress ' + progressClass + '" cx="22" cy="22" r="18" stroke-dasharray="' + circumference + '" stroke-dashoffset="' + offset + '"/></svg>' +
          '<div class="progress-text" style="color:' + pctColor + '">' + pct + '%</div>' +
        '</div>' +
      '</div>';
    } else {
      html += '<div class="shopee-card compact" onclick="viewShopeeId(\'' + item.shopeeId + '\')">' +
        '<div class="shopee-icon">üõí</div>' +
        '<div class="shopee-name">' + item.shopeeId + '</div>' +
        '<div class="progress-ring">' +
          '<svg width="46" height="46"><circle class="bg" cx="23" cy="23" r="18"/><circle class="progress ' + progressClass + '" cx="23" cy="23" r="18" stroke-dasharray="' + circumference + '" stroke-dashoffset="' + offset + '"/></svg>' +
          '<div class="progress-text" style="color:' + pctColor + '">' + pct + '%</div>' +
        '</div>' +
        '<div class="shopee-stats"><span class="stat-paid">‚úì ' + item.paidOrders + '</span><span class="stat-total">/ ' + item.totalOrders + '</span></div>' +
      '</div>';
    }
  });
  html += '</div>';
  container.innerHTML = html;
}

function showAddShopeeModal() {
  document.getElementById('new-shopee-id').value = '';
  showModal('addShopeeModal');
}

function addShopeeId() {
  var shopeeId = document.getElementById('new-shopee-id').value.trim();
  if (!shopeeId) {
    showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Shopee ID');
    return;
  }
  
  apiCall('addShopeeId', { shopeeId: shopeeId }).then(function(data) {
    if (data.success) {
      showToast('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° Shopee ID ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      hideModal('addShopeeModal');
      loadUserData();
    } else {
      showToast('‚ùå ' + (data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'));
    }
  });
}

function viewShopeeId(shopeeId) {
  currentShopeeId = shopeeId;
  var item = userData.shopeeIds.find(s => s.shopeeId === shopeeId);
  
  document.getElementById('view-shopee-name').textContent = shopeeId;
  document.getElementById('view-shopee-stats').textContent = '‚úì ' + (item ? item.paidOrders : 0) + ' / ' + (item ? item.totalOrders : 0) + ' orders';
  
  showModal('viewShopeeModal');
}

function confirmDeleteShopee() {
  document.getElementById('confirm-delete-btn').onclick = function() {
    deleteShopeeId(currentShopeeId);
  };
  hideModal('viewShopeeModal');
  showModal('confirmModal');
}

function deleteShopeeId(shopeeId) {
  apiCall('deleteShopeeId', { shopeeId: shopeeId }).then(function(data) {
    hideModal('confirmModal');
    if (data.success) {
      showToast('‚úÖ ‡∏•‡∏ö Shopee ID ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      loadUserData();
    } else {
      showToast('‚ùå ' + (data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'));
    }
  });
}

// ===== BANK =====
function renderBank() {
  var container = document.getElementById('bank-display');
  var user = userData.user;
  
  if (!user || !user.bankName) {
    container.innerHTML = '<div class="empty-state"><div class="icon">üè¶</div><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</p><button class="btn-save btn" onclick="showBankModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button></div>';
    return;
  }
  
  container.innerHTML = '<div class="bank-card" onclick="showBankModal()">' +
    '<div class="bank-label">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</div>' +
    '<div class="bank-name">' + user.bankName + '</div>' +
    '<div class="bank-account">' + user.bankAccount + '</div>' +
    '<div class="bank-holder">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ' + user.accountName + '</div>' +
    (user.phone ? '<div class="bank-phone">üìû ' + user.phone + '</div>' : '') +
  '</div>';
}

function showBankModal() {
  var user = userData.user || {};
  document.getElementById('input-bank-name').value = user.bankName || '';
  document.getElementById('input-bank-account').value = user.bankAccount || '';
  document.getElementById('input-account-name').value = user.accountName || '';
  document.getElementById('input-phone').value = user.phone || '';
  showModal('bankModal');
}

function saveBank() {
  var params = {
    bankName: document.getElementById('input-bank-name').value,
    bankAccount: document.getElementById('input-bank-account').value.trim(),
    accountName: document.getElementById('input-account-name').value.trim(),
    phone: document.getElementById('input-phone').value.trim()
  };
  
  apiCall('updateBank', params).then(function(data) {
    if (data.success) {
      showToast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      hideModal('bankModal');
      loadUserData();
    } else {
      showToast('‚ùå ' + (data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'));
    }
  });
}

// ===== ORDERS =====
function loadOrders(filter) {
  currentFilter = filter || 'all';
  var params = {};
  
  if (filter === 'user') params.filter = 'user';
  else if (filter === 'admin') params.filter = 'admin';
  else if (filter === 'pending') params.status = '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö';
  else if (filter === 'completed') params.status = '‡πÇ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
  
  apiCall('getOrders', params).then(function(data) {
    if (data.success) {
      renderOrders(data.orders);
    }
  });
}

function filterOrders(filter, btn) {
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  loadOrders(filter);
}

function renderOrders(orders) {
  var container = document.getElementById('orders-list');
  
  if (!orders || orders.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="icon">üì≠</div><p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p></div>';
    return;
  }
  
  var html = '';
  orders.forEach(function(order) {
    var statusClass = (order.status === '‡πÇ‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß' || order.status === 'completed') ? 'completed' : 'pending';
    var byClass = order.createdBy === 'ADMIN' ? 'admin' : 'user';
    var byText = order.createdBy === 'ADMIN' ? 'üõí Admin' : 'üë§ ‡∏â‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°';
    var shopeeIdText = order.shopeeId ? 'üè™ ' + order.shopeeId : '‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ Shopee ID';
    var shopeeIdClass = order.shopeeId ? '' : 'style="color:#dc3545;"';
    
    html += '<div class="order-card" onclick="viewOrder(\'' + order.orderId + '\')">' +
      '<div class="order-header">' +
        '<span class="order-id">üÜî ' + order.orderId + '</span>' +
        '<span class="order-status ' + statusClass + '">' + (order.status || '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö') + '</span>' +
      '</div>' +
      '<div style="font-size:12px;margin-bottom:8px;" ' + shopeeIdClass + '>' + shopeeIdText + '</div>' +
      '<div class="order-body">' +
        '<div class="order-amount">‡∏ø' + numberFormat(order.orderTotal || 0) + '</div>' +
        '<div class="order-meta">' +
          '<div class="order-time">üïê ' + (order.orderTime || '-') + '</div>' +
          '<div class="order-by ' + byClass + '">' + byText + '</div>' +
        '</div>' +
      '</div>' +
      (parseFloat(order.refundAmount) > 0 ? '<div class="order-refund">üí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏≠‡∏Ñ‡∏∑‡∏ô: ‡∏ø' + numberFormat(order.refundAmount) + '</div>' : '') +
    '</div>';
  });
  
  container.innerHTML = html;
}

function viewOrder(orderId) {
  currentOrderId = orderId;
  
  apiCall('getOrderDetail', { orderId: orderId }).then(function(data) {
    if (!data.success) {
      showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Order');
      return;
    }
    
    var order = data.order;
    var userShopeeIds = data.userShopeeIds || [];
    var canEdit = true; // User can edit their orders
    
    var html = '';
    
    // Image
    if (order.imageUrl) {
      html += '<img class="order-image" src="' + order.imageUrl + '" alt="Order Image">';
    }
    
    // Info
    html += '<div class="form-group"><label>Order ID</label><input type="text" value="' + order.orderId + '" disabled></div>';
    html += '<div class="form-group"><label>Order Time</label><input type="text" value="' + (order.orderTime || '-') + '" disabled></div>';
    
    // Shopee ID dropdown
    html += '<div class="form-group"><label>Shopee ID <span style="color:#dc3545;">*</span></label>';
    html += '<select id="edit-shopee-id">';
    html += '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Shopee ID --</option>';
    userShopeeIds.forEach(function(s) {
      var selected = (s.shopeeId === order.shopeeId) ? 'selected' : '';
      html += '<option value="' + s.shopeeId + '" ' + selected + '>' + s.shopeeId + '</option>';
    });
    // ‡∏ñ‡πâ‡∏≤ order.shopeeId ‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô list (‡πÄ‡∏ä‡πà‡∏ô Admin import)
    if (order.shopeeId && !userShopeeIds.find(s => s.shopeeId === order.shopeeId)) {
      html += '<option value="' + order.shopeeId + '" selected>' + order.shopeeId + ' (Admin)</option>';
    }
    html += '</select></div>';
    
    // Editable fields
    html += '<div class="form-group"><label>Subtotal</label><input type="number" id="edit-subtotal" value="' + (order.subtotal || '') + '" ' + (canEdit ? '' : 'disabled') + '></div>';
    html += '<div class="form-group"><label>Shipping</label><input type="number" id="edit-shipping" value="' + (order.shipping || '') + '" ' + (canEdit ? '' : 'disabled') + '></div>';
    html += '<div class="form-group"><label>Shipping Discount</label><input type="number" id="edit-shipping-discount" value="' + (order.shippingDiscount || '') + '" ' + (canEdit ? '' : 'disabled') + '></div>';
    html += '<div class="form-group"><label>Voucher</label><input type="number" id="edit-voucher" value="' + (order.voucher || '') + '" ' + (canEdit ? '' : 'disabled') + '></div>';
    html += '<div class="form-group"><label>Coins Used</label><input type="number" id="edit-coins" value="' + (order.coinsUsed || '') + '" ' + (canEdit ? '' : 'disabled') + '></div>';
    html += '<div class="form-group"><label>Order Total</label><input type="number" id="edit-total" value="' + (order.orderTotal || '') + '" ' + (canEdit ? '' : 'disabled') + '></div>';
    
    // Non-editable
    html += '<div class="form-group"><label>‡∏¢‡∏≠‡∏î‡∏£‡∏≠‡∏Ñ‡∏∑‡∏ô (Admin ‡∏Å‡∏≥‡∏´‡∏ô‡∏î)</label><input type="text" value="‡∏ø' + numberFormat(order.refundAmount || 0) + '" disabled></div>';
    html += '<div class="form-group"><label>‡∏¢‡∏≠‡∏î‡∏°‡∏±‡∏î‡∏à‡∏≥ (Admin ‡∏Å‡∏≥‡∏´‡∏ô‡∏î)</label><input type="text" value="‡∏ø' + numberFormat(order.depositAmount || 0) + '" disabled></div>';
    html += '<div class="form-group"><label>Status (Admin ‡∏Å‡∏≥‡∏´‡∏ô‡∏î)</label><input type="text" value="' + (order.status || '-') + '" disabled></div>';
    
    // History button
    html += '<button class="btn-secondary" style="width:100%;margin-top:10px;" onclick="viewOrderHistory(\'' + orderId + '\')">üìú ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>';
    
    document.getElementById('order-modal-body').innerHTML = html;
    document.getElementById('order-modal-actions').innerHTML = '<button class="btn-cancel" onclick="hideModal(\'orderModal\')">‡∏õ‡∏¥‡∏î</button><button class="btn-save" onclick="saveOrder()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>';
    showModal('orderModal');
  });
}

function saveOrder() {
  var params = {
    orderId: currentOrderId,
    shopeeId: document.getElementById('edit-shopee-id').value,
    subtotal: document.getElementById('edit-subtotal').value,
    shipping: document.getElementById('edit-shipping').value,
    shippingDiscount: document.getElementById('edit-shipping-discount').value,
    voucher: document.getElementById('edit-voucher').value,
    coinsUsed: document.getElementById('edit-coins').value,
    orderTotal: document.getElementById('edit-total').value
  };
  
  // Validate
  var total = parseFloat(params.orderTotal);
  if (total < 0) {
    showToast('‚ùå ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏•‡∏ö');
    return;
  }
  if (total > 10000) {
    if (!confirm('‚ö†Ô∏è ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 10,000 ‡∏ö‡∏≤‡∏ó\n‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
      return;
    }
  }
  
  apiCall('updateOrder', params).then(function(data) {
    if (data.success) {
      showToast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      hideModal('orderModal');
      loadOrders(currentFilter);
      loadUserData(); // Refresh totals
    } else {
      showToast('‚ùå ' + (data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'));
    }
  });
}

function viewOrderHistory(orderId) {
  apiCall('getOrderHistory', { orderId: orderId }).then(function(data) {
    var history = data.history || [];
    
    var html = '<h4 style="margin-bottom:15px;">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</h4>';
    
    if (history.length === 0) {
      html += '<p style="color:#999;text-align:center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</p>';
    } else {
      history.forEach(function(h) {
        var time = new Date(h.timestamp).toLocaleString('th-TH');
        html += '<div class="history-item">' +
          '<div class="history-time">' + time + '</div>' +
          '<div class="history-change">' + h.field + ': <span class="old">' + h.oldValue + '</span> ‚Üí <span class="new">' + h.newValue + '</span></div>' +
        '</div>';
      });
    }
    
    document.getElementById('order-modal-body').innerHTML = html;
    document.getElementById('order-modal-actions').innerHTML = '<button class="btn-cancel" style="width:100%;" onclick="viewOrder(\'' + orderId + '\')">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>';
  });
}

// ===== UTILS =====
function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  
  document.querySelector('.tab:nth-child(' + (tab === 'info' ? 1 : 2) + ')').classList.add('active');
  document.getElementById(tab + '-section').classList.add('active');
  
  if (tab === 'orders') {
    loadOrders(currentFilter);
  }
}

function showModal(id) { document.getElementById(id).classList.add('show'); }
function hideModal(id) { document.getElementById(id).classList.remove('show'); }

function showToast(msg) {
  var toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(function() { toast.classList.remove('show'); }, 2500);
}

function numberFormat(num) {
  return parseFloat(num || 0).toLocaleString('th-TH');
}

// Start
init();
</script>

</body>
</html>
