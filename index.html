<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JAN&ME</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; min-height: 100vh; }
    
    .header { background: linear-gradient(135deg, #FF6B6B, #FF8E53); color: white; padding: 20px; text-align: center; }
    .header h1 { font-size: 24px; margin-bottom: 5px; }
    
    .tabs { display: flex; background: white; border-bottom: 1px solid #eee; }
    .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; border-bottom: 3px solid transparent; }
    .tab.active { color: #FF6B6B; border-bottom-color: #FF6B6B; font-weight: bold; }
    
    .content { padding: 15px; max-width: 500px; margin: 0 auto; padding-bottom: 80px; }
    .section { display: none; }
    .section.active { display: block; }
    
    .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .card-title { font-size: 16px; font-weight: bold; margin-bottom: 15px; color: #333; display: flex; justify-content: space-between; align-items: center; }
    
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; font-size: 14px; color: #666; margin-bottom: 5px; }
    .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
    
    .btn { padding: 12px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer; }
    .btn-primary { background: #FF6B6B; color: white; }
    .btn-secondary { background: #eee; color: #333; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-sm { padding: 8px 12px; font-size: 12px; }
    .btn-add { background: #28a745; color: white; font-size: 20px; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    
    .item-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px; }
    .item-row input { flex: 1; }
    .item-row .btn-remove { background: #dc3545; color: white; width: 32px; height: 32px; border-radius: 50%; font-size: 18px; display: flex; align-items: center; justify-content: center; }
    
    .order-item { background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .order-id { font-weight: bold; color: #FF6B6B; }
    .order-status { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 12px; background: #FFF3CD; color: #856404; }
    
    .empty { text-align: center; padding: 40px; color: #999; }
    .empty-small { text-align: center; padding: 20px; color: #999; font-size: 14px; }
    
    .loading { text-align: center; padding: 40px; }
    .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #FF6B6B; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 8px; display: none; z-index: 1000; }
    .toast.show { display: block; }
    
    .profile-pic { width: 60px; height: 60px; border-radius: 50%; }
    .profile-name { font-size: 18px; font-weight: bold; margin-top: 10px; }
    
    .save-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: none; z-index: 100; }
    .save-bar.show { display: block; }
    .save-bar .btn { width: 100%; }
    
    .bank-info { padding: 15px; background: #f8f9fa; border-radius: 8px; }
    .bank-info p { margin-bottom: 5px; }
    .bank-actions { margin-top: 10px; display: flex; gap: 10px; }
  </style>
</head>
<body>

<div class="header">
  <h1>üè™ JAN&ME</h1>
  <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Order</p>
</div>

<div class="tabs">
  <div class="tab active" onclick="switchTab('info')">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
  <div class="tab" onclick="switchTab('orders')">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
</div>

<div class="content">
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
  </div>
  
  <div id="info-section" class="section">
    <!-- Profile -->
    <div class="card" style="text-align: center;">
      <img id="profile-pic" class="profile-pic" src="" alt="" style="display:none;">
      <div id="profile-name" class="profile-name">-</div>
    </div>
    
    <!-- Shopee IDs -->
    <div class="card">
      <div class="card-title">
        <span>üõí Shopee ID</span>
        <button class="btn btn-add" onclick="addShopeeId()">+</button>
      </div>
      <div id="shopee-list"></div>
    </div>
    
    <!-- Bank Account -->
    <div class="card">
      <div class="card-title">
        <span>üè¶ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</span>
      </div>
      <div id="bank-display"></div>
      <div id="bank-form" style="display:none;">
        <div class="form-group">
          <label>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</label>
          <select id="bank-name">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ --</option>
            <option value="‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢">‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢</option>
            <option value="‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û">‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û</option>
            <option value="‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢">‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢</option>
            <option value="‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå">‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå</option>
            <option value="‡∏ó‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏ò‡∏ô‡∏ä‡∏≤‡∏ï">‡∏ó‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏ò‡∏ô‡∏ä‡∏≤‡∏ï</option>
            <option value="‡∏Å‡∏£‡∏∏‡∏á‡∏®‡∏£‡∏µ">‡∏Å‡∏£‡∏∏‡∏á‡∏®‡∏£‡∏µ</option>
            <option value="‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô">‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô</option>
            <option value="PromptPay">PromptPay</option>
          </select>
        </div>
        <div class="form-group">
          <label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
          <input type="text" id="bank-account" placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ‡∏´‡∏£‡∏∑‡∏≠ ‡πÄ‡∏ö‡∏≠‡∏£‡πå PromptPay">
        </div>
        <div class="form-group">
          <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
          <input type="text" id="account-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
        </div>
      </div>
    </div>
  </div>
  
  <div id="orders-section" class="section">
    <div id="orders-list"></div>
  </div>
</div>

<!-- Save Bar -->
<div class="save-bar" id="save-bar">
  <button class="btn btn-primary" id="save-btn" onclick="saveData()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
</div>

<div class="toast" id="toast"></div>

<script>
// CONFIG
var CONFIG = {
  LIFF_ID: '2009026931-IQy8q5QZ',
  API_URL: 'https://script.google.com/macros/s/AKfycbxc1W4MgiGHFnLh8SrfHeqCbKPU033zbfSoTr-TUeGHuTy4qKcPjeZEvgqXC1PyAYiM/exec'
};

var userId = null;
var originalData = { shopeeIds: [], bank: null };
var currentData = { shopeeIds: [], bank: null };
var hasChanges = false;

async function init() {
  try {
    await liff.init({ liffId: CONFIG.LIFF_ID });
    
    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }
    
    var profile = await liff.getProfile();
    userId = profile.userId;
    
    if (profile.pictureUrl) {
      document.getElementById('profile-pic').src = profile.pictureUrl;
      document.getElementById('profile-pic').style.display = 'block';
    }
    document.getElementById('profile-name').textContent = profile.displayName;
    
    loadData();
    
  } catch (err) {
    document.getElementById('loading').innerHTML = '<p style="color:red;">Error: ' + err.message + '</p>';
  }
}

function loadData() {
  var url = CONFIG.API_URL + '?action=getUserData&userId=' + encodeURIComponent(userId);
  
  fetch(url)
    .then(function(res) { return res.json(); })
    .then(function(data) {
      // Shopee IDs
      originalData.shopeeIds = data.shopeeIds || [];
      currentData.shopeeIds = JSON.parse(JSON.stringify(originalData.shopeeIds));
      renderShopeeIds();
      
      // Bank
      if (data.user && data.user.bankName) {
        originalData.bank = {
          bankName: data.user.bankName,
          bankAccount: data.user.bankAccount,
          accountName: data.user.accountName
        };
        currentData.bank = JSON.parse(JSON.stringify(originalData.bank));
      }
      renderBank();
      
      // Orders
      renderOrders(data.orders || []);
      
      document.getElementById('loading').style.display = 'none';
      document.getElementById('info-section').classList.add('active');
    })
    .catch(function(err) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('info-section').classList.add('active');
    });
}

// ===== SHOPEE ID =====
function renderShopeeIds() {
  var container = document.getElementById('shopee-list');
  
  if (currentData.shopeeIds.length === 0) {
    container.innerHTML = '<div class="empty-small">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Shopee ID<br>‡∏Å‡∏î + ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°</div>';
    return;
  }
  
  var html = '';
  for (var i = 0; i < currentData.shopeeIds.length; i++) {
    html += '<div class="item-row">' +
      '<input type="text" value="' + (currentData.shopeeIds[i].shopeeId || '') + '" onchange="updateShopeeId(' + i + ', this.value)" placeholder="Shopee ID">' +
      '<button class="btn btn-remove" onclick="removeShopeeId(' + i + ')">√ó</button>' +
    '</div>';
  }
  container.innerHTML = html;
}

function addShopeeId() {
  currentData.shopeeIds.push({ shopeeId: '' });
  renderShopeeIds();
  checkChanges();
}

function updateShopeeId(index, value) {
  currentData.shopeeIds[index].shopeeId = value.trim();
  checkChanges();
}

function removeShopeeId(index) {
  currentData.shopeeIds.splice(index, 1);
  renderShopeeIds();
  checkChanges();
}

// ===== BANK =====
function renderBank() {
  var displayDiv = document.getElementById('bank-display');
  var formDiv = document.getElementById('bank-form');
  
  if (currentData.bank && currentData.bank.bankName) {
    displayDiv.innerHTML = '<div class="bank-info">' +
      '<p><strong>üè¶ ' + currentData.bank.bankName + '</strong></p>' +
      '<p>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ' + currentData.bank.bankAccount + '</p>' +
      '<p>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ' + currentData.bank.accountName + '</p>' +
      '<div class="bank-actions">' +
        '<button class="btn btn-secondary btn-sm" onclick="editBank()">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>' +
        '<button class="btn btn-danger btn-sm" onclick="removeBank()">üóëÔ∏è ‡∏•‡∏ö</button>' +
      '</div>' +
    '</div>';
    displayDiv.style.display = 'block';
    formDiv.style.display = 'none';
  } else {
    displayDiv.innerHTML = '<div class="empty-small">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</div>' +
      '<button class="btn btn-secondary" style="width:100%;margin-top:10px;" onclick="showBankForm()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button>';
    displayDiv.style.display = 'block';
    formDiv.style.display = 'none';
  }
}

function showBankForm() {
  document.getElementById('bank-display').style.display = 'none';
  document.getElementById('bank-form').style.display = 'block';
  
  if (currentData.bank) {
    document.getElementById('bank-name').value = currentData.bank.bankName || '';
    document.getElementById('bank-account').value = currentData.bank.bankAccount || '';
    document.getElementById('account-name').value = currentData.bank.accountName || '';
  }
  
  // Add change listeners
  document.getElementById('bank-name').onchange = updateBankFromForm;
  document.getElementById('bank-account').onchange = updateBankFromForm;
  document.getElementById('account-name').onchange = updateBankFromForm;
  
  checkChanges();
}

function editBank() {
  showBankForm();
}

function updateBankFromForm() {
  var bankName = document.getElementById('bank-name').value;
  var bankAccount = document.getElementById('bank-account').value.trim();
  var accountName = document.getElementById('account-name').value.trim();
  
  if (bankName || bankAccount || accountName) {
    currentData.bank = {
      bankName: bankName,
      bankAccount: bankAccount,
      accountName: accountName
    };
  } else {
    currentData.bank = null;
  }
  checkChanges();
}

function removeBank() {
  if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) {
    currentData.bank = null;
    renderBank();
    checkChanges();
  }
}

// ===== SAVE =====
function checkChanges() {
  var origShopee = JSON.stringify(originalData.shopeeIds.map(s => s.shopeeId).filter(s => s));
  var currShopee = JSON.stringify(currentData.shopeeIds.map(s => s.shopeeId).filter(s => s));
  
  var origBank = JSON.stringify(originalData.bank || {});
  var currBank = JSON.stringify(currentData.bank || {});
  
  hasChanges = (origShopee !== currShopee) || (origBank !== currBank);
  
  if (hasChanges) {
    document.getElementById('save-bar').classList.add('show');
  } else {
    document.getElementById('save-bar').classList.remove('show');
  }
}

function saveData() {
  var btn = document.getElementById('save-btn');
  btn.disabled = true;
  btn.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
  
  // Filter empty shopee ids
  var shopeeIds = currentData.shopeeIds
    .map(function(s) { return s.shopeeId; })
    .filter(function(s) { return s && s.length > 0; });
  
  var params = new URLSearchParams({
    action: 'updateUser',
    userId: userId,
    shopeeIds: JSON.stringify(shopeeIds),
    bankName: currentData.bank ? currentData.bank.bankName : '',
    bankAccount: currentData.bank ? currentData.bank.bankAccount : '',
    accountName: currentData.bank ? currentData.bank.accountName : ''
  });
  
  fetch(CONFIG.API_URL + '?' + params.toString())
    .then(function(res) { return res.json(); })
    .then(function(data) {
      btn.disabled = false;
      btn.textContent = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
      
      if (data.success) {
        showToast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
        // Update original data
        originalData.shopeeIds = JSON.parse(JSON.stringify(currentData.shopeeIds));
        originalData.bank = currentData.bank ? JSON.parse(JSON.stringify(currentData.bank)) : null;
        
        // Re-render
        renderShopeeIds();
        renderBank();
        checkChanges();
      } else {
        showToast('‚ùå ' + (data.error || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'));
      }
    })
    .catch(function(err) {
      btn.disabled = false;
      btn.textContent = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
      showToast('‚ùå ' + err.message);
    });
}

// ===== ORDERS =====
function renderOrders(orders) {
  var container = document.getElementById('orders-list');
  
  if (!orders || orders.length === 0) {
    container.innerHTML = '<div class="empty">üì≠ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Order</div>';
    return;
  }
  
  var html = '';
  for (var i = 0; i < orders.length; i++) {
    var order = orders[i];
    html += '<div class="order-item">' +
      '<div style="display:flex;justify-content:space-between;align-items:center;">' +
        '<span class="order-id">üÜî ' + order.orderId + '</span>' +
        '<span class="order-status">' + (order.status || '-') + '</span>' +
      '</div>' +
      '<div style="font-size:18px;font-weight:bold;margin:8px 0;">‡∏ø' + (order.orderTotal || '-') + '</div>' +
      '<div style="font-size:13px;color:#888;">üïê ' + (order.orderTime || '-') + '</div>' +
    '</div>';
  }
  
  container.innerHTML = html;
}

// ===== UTILS =====
function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
  document.querySelectorAll('.section').forEach(function(s) { s.classList.remove('active'); });
  
  event.target.classList.add('active');
  document.getElementById(tab + '-section').classList.add('active');
}

function showToast(msg) {
  var toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(function() { toast.classList.remove('show'); }, 2500);
}

// Start
init();
</script>

</body>
</html>
